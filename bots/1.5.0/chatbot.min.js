let SVG_ICONS={chat:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>',close:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>',minimize:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2z"/></svg>',maximize:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>',restore:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>',share:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>',send:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>',attach:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg>'},phrases={en:{ph:"Type a message...",attach:"Attach a file",send:"Send",close:"Close",maximize:"Maximize",restore:"Restore",file:"File",thinking:"Thinking",minimize:"Minimize"},es:{ph:"Escribe un mensaje...",attach:"Adjuntar un archivo",send:"Enviar",close:"Cerrar",maximize:"Maximizar",restore:"Restaurar",file:"Archivo",thinking:"Pensando",minimize:"Minimizar"},fr:{ph:"Tapez un message...",attach:"Attacher un fichier",send:"Envoyer",close:"Fermer",maximize:"Maximiser",restore:"Restaurer",file:"Fichier",thinking:"Penser",minimize:"Minimiser"}};export default class Chatbot{constructor({id:e,assistant:t,server:s,target:i=void 0,type:o="bubble",style:a={},config:n={}}){if(this.target=i||document.getElementById("chat-container"),this.id=e,this.type=o,this.assistant=t,!this.assistant)throw new Error("Assistant ID is required");if(this.server=s,!this.server)throw new Error("Server URL is required");if(this.style={color:a.color||"#0078d4",font:a.font||"Arial, sans-serif",bubblePosition:a.bubblePosition||"right",bubbleSize:a.bubbleSize||"60px",chatWidth:a.chatWidth||("embed"===o?"100%":"400px"),chatHeight:a.chatHeight||("embed"===o?"100%":"500px"),secondaryFontColor:a.secondaryFontColor||"white",fontFamily:a.fontFamily||"system",googleFont:a.googleFont||"Inter",fontWeight:a.fontWeight||"400",chatAvatar:a.chatAvatar||null,favicon:a.favicon||null,bubbleIcon:a.bubbleIcon||null,bubbleIconImage:a.bubbleIconImage||null,...a},this.config={...n,lang:n.lang||"en",askForCookies:!1!==n.askForCookies,enableCookies:!1!==n.enableCookies,autoSaveSession:!1!==n.autoSaveSession,enableSharing:!1!==n.enableSharing,enableViewHistory:!1!==n.enableViewHistory,maxStoredMessages:n.maxStoredMessages||50,sessionExpiryMinutes:n.sessionExpiryMinutes||720,cookieExpiryMinutes:n.cookieExpiryMinutes||20160,newChatButton:n.newChatButton||!1,pollingInterval:n.pollingInterval||5e3},this.phrases={},!this.config.lang||!phrases[this.config.lang])throw new Error("Language not supported");if(this.phrases=phrases[this.config.lang],this.config.placeholder&&(this.phrases.ph=this.config.placeholder),this.isMaximized=!1,this.messages=[],this.files={},this.loadingTimeout=null,this.sessionId=null,this.cookiesEnabled=!1,this.sessionData=null,this.isMobile=this.detectMobile(),this.pollingTimer=null,this.lastMessageCount=0,this.seenMessageIds=new Set,this.lastMessageTime=0,this.messageCooldown=3e3,this.pollingFailures=0,this.maxPollingFailures=10,!this.target)throw new Error("Target element not found");if(!this.id)throw new Error("Chatbot ID is required");this.injectStyles(),"embed"===this.type?(this.renderEmbed(),this.initializeSession()):this.renderBubble(),this.loadFontsAndAssets()}async retryWithBackoff(e,i=3,o=1e3){for(let s=0;s<i;s++)try{return await e()}catch(e){if(s===i-1)throw e;let t=o*Math.pow(2,s);console.warn(`Retry attempt ${s+1}/${i} after ${t}ms:`,e.message),await new Promise(e=>setTimeout(e,t))}}loadFontsAndAssets(){"google"===this.style.fontFamily&&this.style.googleFont&&this.loadGoogleFont(this.style.googleFont,this.style.fontWeight),this.style.favicon&&this.setFavicon(this.style.favicon)}loadGoogleFont(e,t){var s=document.createElement("link");s.rel="stylesheet",s.href=`https://fonts.googleapis.com/css2?family=${e}:wght@${t}&display=swap`,document.head.appendChild(s)}setFavicon(e){var t=document.createElement("link"),e=(t.rel="icon",t.type="image/x-icon",t.href=e,document.querySelector('link[rel="icon"]'));e&&e.remove(),document.head.appendChild(t)}injectStyles(){var e="left"===this.style.bubblePosition?"left":"right",t="embed"===this.type;let s=this.style.font;"google"===this.style.fontFamily?s=`"${this.style.googleFont}", sans-serif`:"system"===this.style.fontFamily&&(s=this.style.font);t=`
          /* Chat Bubble - only for bubble mode */
          .chat-bubble {
            position: fixed;
            bottom: 20px;
            ${e}: 20px;
            width: ${this.style.bubbleSize};
            height: ${this.style.bubbleSize};
            background: linear-gradient(135deg, ${this.style.color} 0%, ${this.darkenColor(this.style.color,15)} 100%);
            border-radius: 50%;
            box-shadow: 0 4px 20px ${this.hexToRgba(this.style.color,.4)}, 0 8px 32px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: ${s};
            font-weight: ${this.style.fontWeight};
            z-index: 999;
            border: 2px solid rgba(255, 255, 255, 0.2);
          }
          .chat-bubble::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 50%;
            padding: 2px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0.5;
          }
          .chat-bubble:hover {
            transform: translateY(-4px) scale(1.08);
            box-shadow: 0 8px 28px ${this.hexToRgba(this.style.color,.5)}, 0 12px 40px rgba(0, 0, 0, 0.18);
          }
          .chat-bubble:active {
            transform: translateY(-2px) scale(1.04);
          }
          .chat-bubble-icon {
            width: 32px;
            height: 32px;
            color: ${this.style.secondaryFontColor};
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
          }
          .chat-bubble-icon svg {
            width: 100%;
            height: 100%;
          }
          .chat-bubble-icon-image {
            width: 36px;
            height: 36px;
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
          }

          /* Chat Container */
          .chat-container {
            ${t?`
              position: relative;
              width: 100%;
              height: 100%;
              bottom: auto;
              ${e}: auto;
            `:`
              position: fixed;
              bottom: 20px;
              ${e}: 20px;
              width: ${this.style.chatWidth};
              height: ${this.style.chatHeight};
            `}
            background: #ffffff;
            display: flex;
            flex-direction: column;
            border-radius: ${t?"0":"20px"};
            box-shadow: ${t?"none":"0 20px 60px rgba(0, 0, 0, 0.12), 0 8px 24px rgba(0, 0, 0, 0.08)"};
            font-family: ${s};
            font-weight: ${this.style.fontWeight};
            z-index: 1000;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
          }
          .chat-container.maximized {
            bottom: 2.5%;
            ${e}: 2.5%;
            width: 95%;
            height: 95%;
            border-radius: 16px;
          }
          .chat-container.maximized.mobile {
            bottom: 0;
            ${e}: 0;
            width: 100%;
            height: 100%;
            border-radius: 0;
          }

          /* Chat Header */
          .chat-header {
            background: linear-gradient(135deg, ${this.style.color} 0%, ${this.darkenColor(this.style.color,10)} 100%);
            color: ${this.style.secondaryFontColor};
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            border-radius: ${t?"0":"20px 20px 0 0"};
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
          }
          .chat-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(0, 0, 0, 0.05);
          }
          .chat-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 18px;
          }
          .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }
          .chat-header p {
            margin: 0;
            font-size: 13px;
            opacity: 0.9;
          }
          .chat-header button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: ${this.style.secondaryFontColor};
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            padding: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .chat-header button svg {
            width: 20px;
            height: 20px;
          }
          .chat-header button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
          }
          .chat-header button:active {
            transform: scale(0.95);
          }

          /* Chat Body */
          .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            font-size: 15px;
            color: #2c3e50;
            font-family: ${s};
            font-weight: ${this.style.fontWeight};
            background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
          }
          .chat-body::-webkit-scrollbar {
            width: 6px;
          }
          .chat-body::-webkit-scrollbar-track {
            background: transparent;
            margin: 4px 0;
          }
          .chat-body::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.08);
            border-radius: 3px;
          }
          .chat-body::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.14);
          }

          /* Chat Messages */
          .chat-message {
            padding: 12px 16px;
            border-radius: 20px;
            max-width: 75%;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.6;
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
          }
          @keyframes messageSlideIn {
            from {
              opacity: 0;
              transform: translateY(12px) scale(0.98);
            }
            to {
              opacity: 1;
              transform: translateY(0) scale(1);
            }
          }
          .chat-message.bot {
            background: linear-gradient(135deg, ${this.style.color} 0%, ${this.darkenColor(this.style.color,8)} 100%);
            color: ${this.style.secondaryFontColor};
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 12px ${this.hexToRgba(this.style.color,.15)};
          }
          .chat-message.user {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            color: #2c3e50;
            align-self: flex-end;
            flex-direction: row-reverse;
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0, 0, 0, 0.04);
          }
          .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
            border: 1.5px solid rgba(255, 255, 255, 0.8);
          }
          .message-content {
            flex: 1;
            font-size: 14px;
            line-height: 1.6;
          }
          .message-content strong {
            font-weight: 700;
          }
          .message-content em {
            font-style: italic;
          }
          .message-content ul,
          .message-content ol {
            margin: 8px 0;
            padding-left: 24px;
          }
          .message-content ul {
            list-style-type: disc;
          }
          .message-content ol {
            list-style-type: decimal;
          }
          .message-content li {
            margin: 4px 0;
            line-height: 1.5;
          }
          .message-content br {
            display: block;
            content: "";
            margin: 4px 0;
          }

          /* Chat Input */
          .chat-input {
            padding: 16px 20px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.02);
          }
          .chat-input input[type="text"] {
            flex: 1;
            padding: 13px 18px;
            border: 1.5px solid #e5e7eb;
            border-radius: 24px;
            font-size: 14px;
            font-family: ${s};
            font-weight: ${this.style.fontWeight};
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            background: #f9fafb;
            color: #2c3e50;
          }
          .chat-input input[type="text"]:focus {
            outline: none;
            border-color: ${this.style.color};
            background: #ffffff;
            box-shadow: 0 0 0 3px ${this.hexToRgba(this.style.color,.08)}, 0 2px 8px rgba(0, 0, 0, 0.04);
            transform: translateY(-1px);
          }
          .chat-input input[type="text"]::placeholder {
            color: #9ca3af;
          }
          .chat-input button {
            padding: 13px 24px;
            background: linear-gradient(135deg, ${this.style.color} 0%, ${this.darkenColor(this.style.color,8)} 100%);
            color: ${this.style.secondaryFontColor};
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-family: ${s};
            font-weight: 600;
            font-size: 14px;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 14px ${this.hexToRgba(this.style.color,.25)};
          }
          .chat-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px ${this.hexToRgba(this.style.color,.35)};
          }
          .chat-input button:active {
            transform: translateY(-1px);
          }
          .chat-input button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
          }
          .chat-input input[type="file"] {
            display: none;
          }
          .chat-input label {
            background: #f0f0f0;
            color: #2c3e50;
            padding: 10px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-family: ${s};
            font-weight: ${this.style.fontWeight};
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          .chat-input label:hover {
            background: #e0e0e0;
            transform: scale(1.05);
          }

          /* Loading Animation */
          .chat-loading {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-radius: 20px;
            max-width: 75%;
            align-self: flex-start;
            font-size: 14px;
            color: #6b7280;
            font-style: italic;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-bottom-left-radius: 6px;
            font-family: ${s};
            font-weight: ${this.style.fontWeight};
            animation: messageSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
          }
          .chat-loading::before {
            content: '';
            width: 10px;
            height: 10px;
            background: ${this.style.color};
            border-radius: 50%;
            animation: pulse 1.4s ease-in-out infinite;
            box-shadow: 0 0 8px ${this.hexToRgba(this.style.color,.4)};
          }
          @keyframes pulse {
            0%, 100% {
              opacity: 0.4;
              transform: scale(0.85);
            }
            50% {
              opacity: 1;
              transform: scale(1.15);
            }
          }
          .chat-loading::after {
            content: "";
            display: inline-block;
            width: 1em;
            text-align: left;
            animation: loading-dots 1.5s infinite steps(3, end);
          }
          @keyframes loading-dots {
            0% {
              content: "";
            }
            33% {
              content: ".";
            }
            66% {
              content: "..";
            }
            100% {
              content: "...";
            }
          }

          /* Mobile Responsive */
          @media (max-width: 768px) {
            .chat-bubble {
              width: 64px;
              height: 64px;
              bottom: 16px;
              ${e}: 16px;
            }
            .chat-bubble-icon {
              font-size: 32px;
            }
            .chat-bubble-icon-image {
              width: 42px;
              height: 42px;
            }
            .chat-container:not(.maximized) {
              bottom: 16px;
              ${e}: 16px;
              width: calc(100vw - 32px);
              height: calc(100vh - 32px);
              max-width: 420px;
              max-height: 640px;
            }
            .chat-header {
              padding: 14px 16px;
            }
            .chat-header h3 {
              font-size: 16px;
            }
            .chat-header button {
              font-size: 22px;
              width: 36px;
              height: 36px;
            }
            .chat-body {
              padding: 16px;
            }
            .chat-input {
              padding: 12px 16px;
            }
            .chat-input input[type="text"] {
              padding: 14px 18px;
              font-size: 16px;
            }
            .chat-input button {
              padding: 14px 22px;
              font-size: 16px;
            }
            .chat-input label {
              padding: 12px 16px;
            }
          }
        `,e=document.createElement("style");e.type="text/css",e.textContent=t,document.head.appendChild(e)}darkenColor(e,t){var s=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),e=parseInt(e.slice(5,7),16),s=Math.floor(s*(1-t/100)),i=Math.floor(i*(1-t/100)),e=Math.floor(e*(1-t/100));return"#"+s.toString(16).padStart(2,"0")+i.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")}hexToRgba(e,t){return e=e.replace("#",""),`rgba(${parseInt(e.slice(0,2),16)}, ${parseInt(e.slice(2,4),16)}, ${parseInt(e.slice(4,6),16)}, ${t})`}parseMarkdown(e){let i=e=>{var t=document.createElement("div");return t.textContent=e,t.innerHTML};e=e.split("\n");let o=[],a=null,n=[],r=()=>{var e,t;a&&0<n.length&&(e=a,t=n.map(e=>`<li>${e}</li>`).join(""),o.push(`<${e}>${t}</${e}>`),n=[],a=null)};return e.forEach((e,t)=>{var s=e.match(/^[\s]*[-*]\s+(.+)$/);s?("ul"!==a&&(r(),a="ul"),n.push(this.parseInlineMarkdown(i(s[1])))):(s=e.match(/^[\s]*\d+\.\s+(.+)$/))?("ol"!==a&&(r(),a="ol"),n.push(this.parseInlineMarkdown(i(s[1])))):(r(),""===e.trim()?o.push("<br>"):o.push(this.parseInlineMarkdown(i(e))))}),r(),o.join("\n")}parseInlineMarkdown(e){return e=(e=(e=(e=e.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>")).replace(/__(.+?)__/g,"<strong>$1</strong>")).replace(/(\s|^)\*([^\*\s].*?[^\*\s]|\S)\*(\s|$|[,.!?;:])/g,"$1<em>$2</em>$3")).replace(/(\s|^)_([^_\s].*?[^_\s]|\S)_(\s|$|[,.!?;:])/g,"$1<em>$2</em>$3")}renderBubble(){var e,t=document.createElement("div");t.className="chat-bubble",this.style.bubbleIconImage?((e=document.createElement("img")).src=this.style.bubbleIconImage,e.alt="Chat",e.className="chat-bubble-icon-image",t.appendChild(e)):this.style.bubbleIcon?t.innerHTML=`<span class="chat-bubble-icon">${this.style.bubbleIcon}</span>`:t.innerHTML=`<span class="chat-bubble-icon">${SVG_ICONS.chat}</span>`,t.addEventListener("click",()=>this.renderChatWindow()),this.target.appendChild(t)}async renderChatWindow(){this.target.innerHTML="",this.sessionId||((t=this.getSessionIdFromURL())?(console.log("Resuming session from URL: "+t),this.sessionId=t,await this.loadSessionHistory()):this.config.enableCookies&&this.cookiesEnabled&&(this.sessionData=this.loadSessionData(),this.sessionData)&&(console.log("Resuming session from cookies: "+this.sessionData.sessionId),this.sessionId=this.sessionData.sessionId,await this.loadSessionHistory()));let e=document.createElement("div");e.className="chat-container";var t=document.createElement("div"),s=(t.className="chat-header",document.createElement("h3")),i=(this.style.chatAvatar&&((i=document.createElement("img")).className="chat-avatar",i.src=this.style.chatAvatar,i.alt="Chat Assistant",s.appendChild(i)),document.createTextNode(this.config.headerTitle||"Chat Assistant")),i=(s.appendChild(i),t.appendChild(s),document.createElement("div")),s=(i.style.display="flex",i.style.gap="8px",document.createElement("button")),o=(s.innerHTML=SVG_ICONS.minimize,s.title=this.phrases.minimize,s.addEventListener("click",()=>{this.stopPolling(),this.target.innerHTML="",this.renderBubble()}),document.createElement("button"));o.innerHTML=SVG_ICONS.close,o.title=this.phrases.close,o.addEventListener("click",()=>{confirm("Are you sure you want to close the chat? The session will be lost.")&&(this.stopPolling(),this.messages=[],this.sessionId=null,this.cookiesEnabled&&this.deleteCookie(`chatbot_${this.id}_session`),this.target.innerHTML="",this.renderBubble())});let a=document.createElement("button");a.innerHTML=SVG_ICONS.maximize,a.title=this.phrases.maximize,a.addEventListener("click",()=>{this.isMaximized=!this.isMaximized,a.innerHTML=this.isMaximized?SVG_ICONS.restore:SVG_ICONS.maximize,a.title=this.isMaximized?this.phrases.restore:this.phrases.maximize,e.classList.toggle("maximized"),this.isMobile&&e.classList.toggle("mobile")});var n=document.createElement("button"),r=(n.innerHTML=SVG_ICONS.share,n.title="Share Session",n.addEventListener("click",()=>this.copySessionURL()),this.config.newChatButton&&((r=document.createElement("button")).innerHTML=SVG_ICONS.chat,r.title="New Chat",r.addEventListener("click",()=>this.startNewChat()),i.appendChild(r)),i.appendChild(s),i.appendChild(a),i.appendChild(o),i.appendChild(n),t.appendChild(i),this.createChatBody()),s=this.createChatInput();e.appendChild(t),e.appendChild(r),e.appendChild(s),this.target.appendChild(e),0<this.messages.length?this.messages.forEach(e=>{this.addMessage(e.content,e.sender,!1)}):this.config.welcomeMessage&&this.addMessage(this.config.welcomeMessage,"bot",!0),this.sessionId&&this.startPolling()}createChatBody(){var e=document.createElement("div");return e.className="chat-body",e}createChatInput(){var e=document.createElement("div");e.className="chat-input";let t=document.createElement("input");t.type="text",t.placeholder=this.phrases.ph;var s=document.createElement("button");return s.textContent=this.phrases.send,s.title=this.phrases.send,s.addEventListener("click",()=>{var e=t.value.trim();e&&(this.addMessage(e,"user"),t.value="")}),t.addEventListener("keydown",e=>{"Enter"===e.key&&(e=t.value.trim())&&(this.addMessage(e,"user"),t.value="")}),e.appendChild(t),e.appendChild(s),e}async renderEmbed(){this.target.innerHTML="";var e=document.createElement("div"),t=(e.className="chat-container",document.createElement("div")),s=(t.className="chat-header",document.createElement("h3")),i=(this.style.chatAvatar&&((i=document.createElement("img")).className="chat-avatar",i.src=this.style.chatAvatar,i.alt="Chat Assistant",s.appendChild(i)),document.createTextNode(this.config.headerTitle||"Chat Assistant")),i=(s.appendChild(i),t.appendChild(s),document.createElement("div")),s=(i.style.display="flex",i.style.gap="8px",document.createElement("button")),o=(s.innerHTML=SVG_ICONS.share,s.title="Share Session",s.addEventListener("click",()=>this.copySessionURL()),this.config.newChatButton&&((o=document.createElement("button")).innerHTML=SVG_ICONS.chat,o.title="New Chat",o.addEventListener("click",()=>this.startNewChat()),i.appendChild(o)),i.appendChild(s),t.appendChild(i),this.createChatBody()),s=(o.classList.add("embed"),this.createChatInput());e.appendChild(t),e.appendChild(o),e.appendChild(s),this.target.appendChild(e),await this.initializeSession(),this.sessionId&&this.startPolling()}addMessage(e,t,s=!0){var i,o,a=this.target.querySelector(".chat-body");a&&((i=document.createElement("div")).className="chat-message "+t,"bot"===t&&this.style.chatAvatar&&((o=document.createElement("img")).className="message-avatar",o.src=this.style.chatAvatar,o.alt="Bot",i.appendChild(o)),(o=document.createElement("div")).className="message-content","bot"===t?o.innerHTML=this.parseMarkdown(e):o.textContent=e,i.appendChild(o),a.appendChild(i),a.scrollTop=a.scrollHeight,s&&(this.messages.push({content:e,sender:t}),this.lastMessageCount=this.messages.length,this.cookiesEnabled)&&this.config.autoSaveSession&&this.sessionId&&this.updateLastMessageTime(),"user"===t)&&this.sendUserMessage(e)}async sendUserMessage(t){var e=Date.now(),s=e-this.lastMessageTime;if(s<this.messageCooldown)s=Math.ceil((this.messageCooldown-s)/1e3),this.addMessage(`Please wait ${s} seconds before sending another message.`,"bot",!1);else{this.lastMessageTime=e,this.triggerLoadingBubble();try{let e;this.sessionId?e=await this.retryWithBackoff(async()=>{var e=await fetch(`${this.server}/api/v1/chat/${this.assistant}/chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,session_id:this.sessionId})});if(e.ok)return e.json();throw new Error("Failed to send message: "+e.statusText)}):(console.log("Starting new session with user's first message"),e=await this.retryWithBackoff(async()=>{var e=await fetch(`${this.server}/api/v1/chat/${this.assistant}/start_chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})});if(e.ok)return e.json();throw new Error("Failed to start chat: "+e.statusText)}),this.sessionId=e.session_id,console.log("New session started: "+this.sessionId),this.cookiesEnabled&&this.config.autoSaveSession&&this.saveSessionData(),this.startPolling()),this.resetLoadingBubble(),this.addMessage(e.response,"bot",!0)}catch(e){console.error("Failed to send message after retries:",e),this.resetLoadingBubble(),this.addMessage("Sorry, I'm having trouble responding right now. Please try again.","bot",!1)}}}async initializeSession(){try{this.config.enableCookies?this.config.askForCookies&&!this.cookiesEnabled?await this.askForCookiePermission()||console.log("Cookies declined"):this.config.askForCookies||(this.cookiesEnabled=!0,console.log("Cookies auto-enabled based on configuration")):(this.cookiesEnabled=!1,console.log("Cookies disabled by configuration"));var e=this.getSessionIdFromURL();e?(console.log("Resuming session from URL: "+e),this.sessionId=e,await this.loadSessionHistory()):this.cookiesEnabled&&(this.sessionData=this.loadSessionData(),this.sessionData)?(console.log("Resuming session from cookies: "+this.sessionData.sessionId),this.sessionId=this.sessionData.sessionId,await this.loadSessionHistory()):console.log("No existing session found - will create on first user message")}catch(e){console.error("Failed to initialize session:",e),this.showInitializationError()}}showInitializationError(){var e,t=this.target.querySelector(".chat-body");t&&((e=document.createElement("div")).className="initialization-error",e.style.cssText=`
      padding: 16px;
      margin: 20px;
      background: #fee;
      border: 2px solid #fcc;
      border-radius: 8px;
      color: #c33;
      text-align: center;
      font-size: 14px;
    `,e.innerHTML=`
      <div style="font-weight: 600; margin-bottom: 8px;">Failed to Initialize Chat</div>
      <div style="margin-bottom: 12px;">Unable to connect to the chat service. Please try again.</div>
      <button onclick="location.reload()" style="
        padding: 8px 16px;
        background: #c33;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      ">Retry</button>
    `,t.appendChild(e))}async loadSessionHistory(){try{var e=await fetch(`${this.server}/api/v1/chat/sessions/${this.sessionId}/history`);if(!e.ok)throw new Error("Failed to load history");var t=await e.json();t.messages&&0<t.messages.length&&(this.messages=t.messages.map(e=>({content:e.content,sender:"user"===e.role?"user":"bot"})),this.messages.forEach(e=>{this.addMessage(e.content,e.sender,!1)}),this.lastMessageCount=this.messages.length,console.log(`Restored ${this.messages.length} messages from history`))}catch(e){console.warn("Failed to load session history:",e)}}async startNewSession(){try{var e=await this.retryWithBackoff(async()=>{var e=await fetch(`${this.server}/api/v1/chat/${this.assistant}/start_chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:"Hello"})});if(e.ok)return e.json();throw new Error("Failed to start session: "+e.statusText)});this.sessionId=e.session_id,console.log("New session started: "+this.sessionId),this.addMessage(e.response,"bot",!0),this.lastMessageCount=1,this.cookiesEnabled&&this.config.autoSaveSession&&this.saveSessionData()}catch(e){throw console.error("Failed to start new session after retries:",e),e}}startPolling(){this.pollingTimer&&clearInterval(this.pollingTimer);var e=this.target.querySelector('.chat-input input[type="text"]'),t=this.target.querySelector(".chat-input button");e&&e.disabled&&(e.disabled=!1,e.placeholder=this.phrases.ph),t&&t.disabled&&(t.disabled=!1),this.pollingTimer=setInterval(async()=>{await this.pollForNewMessages()},this.config.pollingInterval)}stopPolling(){this.pollingTimer&&(clearInterval(this.pollingTimer),this.pollingTimer=null)}async pollForNewMessages(){if(this.sessionId)try{var e=await fetch(`${this.server}/api/v1/chat/sessions/${this.sessionId}/history`);if(!e.ok)throw new Error("Failed to poll: "+e.statusText);var t=await e.json();this.pollingFailures=0,t.messages&&0<t.messages.length&&(t.messages.forEach(t=>{var e;t.id&&this.seenMessageIds.has(t.id)||this.messages.some(e=>e.content===t.content&&e.sender===("user"===t.role?"user":"bot"))||(e="user"===t.role?"user":"bot",this.addMessage(t.content,e,!0),t.id&&this.seenMessageIds.add(t.id))}),this.lastMessageCount=t.messages.length)}catch(e){this.pollingFailures++,console.warn(`Polling failure ${this.pollingFailures}/${this.maxPollingFailures}:`,e.message),this.pollingFailures>=this.maxPollingFailures&&(this.stopPolling(),this.showPollingError())}}showPollingError(){let t=this.target.querySelector(".chat-body");if(t){var s=t.querySelector(".polling-error");if(!s){let e=document.createElement("div");e.className="polling-error",e.style.cssText=`
      padding: 12px;
      margin: 10px 0;
      background: #fee;
      border: 1px solid #fcc;
      border-radius: 8px;
      color: #c33;
      text-align: center;
      font-size: 14px;
    `,e.innerHTML=`
      <div>Connection lost. Unable to receive new messages.</div>
      <div style="display: flex; gap: 8px; justify-content: center; margin-top: 8px;">
        <button class="retry-polling-btn" style="
          padding: 6px 12px;
          background: #0078d4;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        ">Retry Connection</button>
        <button onclick="location.reload()" style="
          padding: 6px 12px;
          background: #c33;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        ">Refresh Page</button>
      </div>
    `;e.querySelector(".retry-polling-btn").addEventListener("click",()=>{this.pollingFailures=0,t.removeChild(e),this.startPolling()}),t.appendChild(e),t.scrollTop=t.scrollHeight;var s=this.target.querySelector('.chat-input input[type="text"]'),i=this.target.querySelector(".chat-input button");s&&(s.disabled=!0,s.placeholder="Connection lost..."),i&&(i.disabled=!0)}}}triggerLoadingBubble(){this.loadingTimeout&&clearTimeout(this.loadingTimeout),this.loadingTimeout=setTimeout(()=>{this.addLoadingBubble()},1e3)}addLoadingBubble(){var e,t=this.target.querySelector(".chat-body");t&&!t.querySelector(".chat-loading")&&((e=document.createElement("div")).className="chat-loading",e.textContent="Thinking",t.appendChild(e),t.scrollTop=t.scrollHeight)}resetLoadingBubble(){var e,t=this.target.querySelector(".chat-body");t&&((e=t.querySelector(".chat-loading"))&&t.removeChild(e),this.loadingTimeout)&&(clearTimeout(this.loadingTimeout),this.loadingTimeout=null)}setCookie(e,t,s=10080){try{var i=new Date;return i.setTime(i.getTime()+60*s*1e3),document.cookie=`${e}=${t};expires=${i.toUTCString()};path=/`,this.cookiesEnabled=!0}catch(e){return console.warn("Cookies not supported:",e),this.cookiesEnabled=!1}}getCookie(e){try{var s=e+"=",i=document.cookie.split(";");for(let t=0;t<i.length;t++){let e=i[t];for(;" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(s))return this.cookiesEnabled=!0,e.substring(s.length,e.length)}return null}catch(e){return console.warn("Cookies not accessible:",e),this.cookiesEnabled=!1,null}}deleteCookie(e){try{return document.cookie=e+"=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;",!0}catch(e){return console.warn("Could not delete cookie:",e),!1}}saveSessionData(){var e;return!!(this.cookiesEnabled&&this.sessionId&&this.config.autoSaveSession)&&(e={sessionId:this.sessionId,startTime:Date.now(),lastMessageTime:Date.now(),assistant:this.assistant,messages:this.config.enableViewHistory?this.messages.slice(-this.config.maxStoredMessages):[]},this.setCookie(`chatbot_${this.id}_session`,JSON.stringify(e),this.config.cookieExpiryMinutes))}loadSessionData(){var e=this.getCookie(`chatbot_${this.id}_session`);if(!e)return null;try{var t=JSON.parse(e),s=Date.now()-t.startTime;return 60*this.config.sessionExpiryMinutes*1e3<s?(this.deleteCookie(`chatbot_${this.id}_session`),null):t.assistant!==this.assistant?(this.deleteCookie(`chatbot_${this.id}_session`),null):t}catch(e){return console.warn("Invalid session data in cookie:",e),this.deleteCookie(`chatbot_${this.id}_session`),null}}updateLastMessageTime(){if(this.cookiesEnabled&&this.sessionId&&this.config.autoSaveSession){var e=this.getCookie(`chatbot_${this.id}_session`);if(e)try{var t=JSON.parse(e);t.lastMessageTime=Date.now(),t.messages=this.config.enableViewHistory?this.messages.slice(-this.config.maxStoredMessages):[],this.setCookie(`chatbot_${this.id}_session`,JSON.stringify(t),this.config.cookieExpiryMinutes)}catch(e){console.warn("Could not update session data:",e)}}}getSessionIdFromURL(){return new URLSearchParams(window.location.search).get("session_id")}askForCookiePermission(){return new Promise(e=>{let t=document.createElement("div");t.className="cookie-permission-dialog",t.innerHTML=`
        <div class="cookie-dialog-content">
          <h3>Enable Chat History</h3>
          <p>Would you like to enable cookies to save your chat history? This will allow you to continue sessions even after closing your browser.</p>
          <div class="cookie-buttons">
            <button class="cookie-accept">Accept</button>
            <button class="cookie-decline">Decline</button>
          </div>
        </div>
      `;var s=`
        .cookie-permission-dialog {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        }
        .cookie-dialog-content {
          background: white;
          padding: 20px;
          border-radius: 10px;
          max-width: 400px;
          text-align: center;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .cookie-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        .cookie-buttons button {
          padding: 10px 20px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 14px;
        }
        .cookie-accept {
          background-color: ${this.style.color};
          color: white;
        }
        .cookie-decline {
          background-color: #e1e1e1;
          color: #333;
        }
      `,i=document.createElement("style");i.type="text/css",i.textContent=s,i.id="cookie-dialog-styles",document.head.appendChild(i),document.body.appendChild(t);let o=()=>{document.body.removeChild(t);var e=document.getElementById("cookie-dialog-styles");e&&document.head.removeChild(e)};t.querySelector(".cookie-accept").addEventListener("click",()=>{o(),this.cookiesEnabled=!0,e(!0)}),t.querySelector(".cookie-decline").addEventListener("click",()=>{o(),this.cookiesEnabled=!1,e(!1)})})}generateShareableURL(){var e;return this.sessionId?((e=new URL(window.location.href)).searchParams.set("session_id",this.sessionId),e.toString()):null}async copySessionURL(){var t=this.generateShareableURL();if(t)try{await navigator.clipboard.writeText(t),alert("Session URL copied to clipboard!")}catch(e){var s=document.createElement("textarea");s.value=t,document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),alert("Session URL copied to clipboard!")}else alert("No session to share")}async startNewChat(){var e;confirm("Start a new chat? The current session will be lost.")&&(this.stopPolling(),this.messages=[],this.sessionId=null,this.sessionData=null,this.lastMessageCount=0,this.seenMessageIds.clear(),this.lastMessageTime=0,this.pollingFailures=0,this.cookiesEnabled&&this.deleteCookie(`chatbot_${this.id}_session`),(e=this.target.querySelector(".chat-body"))&&(e.innerHTML=""),this.config.welcomeMessage)&&this.addMessage(this.config.welcomeMessage,"bot",!0)}detectMobile(){return[/Android/i,/webOS/i,/iPhone/i,/iPad/i,/iPod/i,/BlackBerry/i,/Windows Phone/i].some(e=>navigator.userAgent.match(e))}}"undefined"!=typeof window&&(window.Chatbot=Chatbot);